---
title: "Modding Rome Total War (Avatar, The Last Airbender mod) using R"
always_allow_html: yes
output: 
  md_document:
    variant: markdown_github
    toc: TRUE
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This blog post will be on a very weird mash-up of a few of my interests, Rome: Total War, Avatar: The Last Airbender, and of course the R programming language! I'll introduce these drastically different interests first...

## __What is Rome: Total War?__ 

- A turn-based strategy RPG game set in the early years of the Roman Republic that was released back in 2004. There's both a campaign map where you do management (akin to say Civ or EU games) but a major difference to those games is that you can also fight the battles yourself on the battle map with the troops you've recruited. 

![]()

- It's probably the game I've played the most, ever. Yes, even more than FIFA actually (I haven't played FIFA in nearly a decade now actually...). I have the original CD version that I bought when I lived in Israel, the Steam version which I play on today, and I also got the Re-mastered version as that's the version that works with the Avatar mod.

## __What is Avatar: The Last Airbender?__

- 

![]()

- It got pretty popular again during the pandemic I feel... Most likely because the people who watched it when they were kids are right around the late 20s/early 30s-ish age that are pretty active on social media and people wanted some comfort-shows to watch in those uncertain times.

## __What is the Avatar: The Last Airbender mod for Rome: Total War?__

I was working on this during fall of last year but then I got busy (J.League review, World Cup, etc.) so I never wrote up the blog post in full. A lot of the actual modding is done outside of R, but as always I was able to find ways to use R to my advantage to improve this mod.

"and now for something completely different..."

Let's get started!

## Web-scraping Avatar characters to add into the game.

When I first acme across this mod, I realized pretty quickly that there weren't a whole lot of character names for each of the tribes. So after like 50 turns or so of playing the game, you wind up having a dozen or so "Katara"s running around in your Water Tribe kingdom or 50 "Zuko"s in your Fire Nation Empire. Therefore I took it upon myself to add more character names by extracting names and gender from the [Avatar fandom wiki](https://avatar.fandom.com/wiki/Avatar_Wiki).

First, let's load some R packages: 

```{r}
library(rvest)   ## web-scraping
library(polite)  ## web-scraping, politely
library(dplyr)   ## clean data
library(purrr)   ## clean data and iteration
library(stringr) ## string/text cleaning
```

Before I jumped into creating a big workflow, I wanted to test how to grab the data I need based on one page.

```{r}
## Check out robots.txt and see if URL link is scrape-able
session2 <- bow("https://avatar.fandom.com/wiki/Azula")

## Find the character info box on the right corner and 
## grab all the text, then extract the gender identifying words
gender_is <- scrape(session2) %>%
  html_nodes(".portable-infobox") %>%
  html_text() %>%
  ## Some characters are non-binary or gender isn't listed
  stringr::str_extract("Female|Male|Man|Woman") 

gender_is
```

Great! After flipping through a few character pages at random, this is how these pages are set up so I should be able to apply the above code to **every** character page to extract the character name and their gender. 

NOTE: Since the time I actually worked on this last October, there's been quite a few weird changes in the pages where instead of simply listing gender as "Male" or "Female" or otherwise, some pages keep the "Male"/"Female" set while others have "Man" or "Woman" instead... so the consistency across character pages got worse, wonderful!

So to expand this search across all characters, I tried to find a pages that listed them all. There wasn't one but there are a couple of pages that lists all characters split by tribe/nation which is still more than enough for what I wanted to do.

```{r}
earth_url <- "https://avatar.fandom.com/wiki/Category:Earth_Kingdom_characters"
fire_url <- "https://avatar.fandom.com/wiki/Category:Fire_Nation_characters"
water_url <- "https://avatar.fandom.com/wiki/Category:Water_Tribe_characters"
air_url <- "https://avatar.fandom.com/wiki/Category:Air_Nomad_characters"
```

So from here, I need to grab:

- The character's name
- The URL link to that character's page

```{r, eval=FALSE}
## one nation
bender_url <- earth_url
bender_label <- str_extract(bender_url, "Fire|Earth|Water|Air")

cat(paste0("\nStarting: ", bender_label, "!\n"))
## Get name and page link
session <- bow(bender_url)

char_link <- scrape(session) %>%
  html_nodes(".category-page__member-link") %>%
  html_attr("href")

char_name <- scrape(session) %>%
  html_nodes(".category-page__member-link") %>%
  html_text()

base_url <- "https://avatar.fandom.com/"

earth_df <- data.frame(
  char_link,
  char_name
) %>%
  ## Strip out 'Category:' pages that aren't single character page links
  filter(!str_detect(char_link, "Category")) %>%
  mutate(char_link = paste0(base_url, char_link))

cat("\nNames and page link done!\n")
```

```{r, echo=FALSE}

```

```{r}
earth_df
```

Then use that information to:

- Jump into each character page to find their gender
- Bind all individual character info into one data.frame and save that as an `.RDS` file

```{r, eval=FALSE}
## find all genders at once
earth_namegender_df <- map(
  earth_df$earth_link,
  ~ get_gender(data = earth_df, link = .x)
) %>%
  purrr::reduce(earth_namegender_df, bind_rows)

saveRDS(earth_namegender_df, file = "data/earth_namegender_df.RDS")
```

Of course, after running through one nation's worth of character pages I can then standardize it as one big function to take any of the character list URLs.

```{r}
get_character_info <- function(bender_url) {
  bender_label <- str_extract(bender_url, "Fire|Earth|Water|Air")

  cat(paste0("\nStarting: ", bender_label, "!\n"))
  ## Get name and page link
  session <- bow(bender_url)

  char_link <- scrape(session) %>%
    html_nodes(".category-page__member-link") %>%
    html_attr("href")

  char_name <- scrape(session) %>%
    html_nodes(".category-page__member-link") %>%
    html_text()

  base_url <- "https://avatar.fandom.com/"

  char_df <- data.frame(
    char_link,
    char_name
  ) %>%
    ## Strip out 'Category:' pages that aren't single character page links
    filter(!str_detect(char_link, "Category")) %>%
    mutate(char_link = paste0(base_url, char_link))

  cat("\nNames and page link done!\n")

  ## Get gender
  get_gender <- function(data, link) {
    cat(paste0("\nStarting: ", link))
    session2 <- bow(link)

    gender_is <- scrape(session2) %>%
      html_nodes(".portable-infobox") %>%
      html_text() %>%
      stringr::str_extract("Female|Male|Man|Woman") ## Some are "Non-binary" or gender isn't listed

    cat(paste0("\nGender: ", gender_is))

    final_df <- data %>%
      filter(char_link == link)

    if (class(gender_is) != "character") {
      final_df <- final_df %>%
        mutate(gender = NA_character_)
    } else {
      final_df <- final_df %>%
        mutate(gender = gender_is)
    }

    cat("\nDone!\n")

    return(final_df)
  }

  char_namegender_df <- map(
    char_df$char_link,
    ~ get_gender(data = char_df, link = .x)
  ) %>%
    purrr::reduce(bind_rows)

  saveRDS(char_namegender_df, file = here::here(paste0("data/", bender_label, "_namegender_df.RDS")))

  cat(paste0("\nScript for: ", bender_label, " done!\n"))
}
```

And from here I basically shoved all these character names by nation/tribe into the game's character files using NotePad++ since most of the game is built on simple text files! It's very easy to mod this part of the game, all of the model/map rendering and stuff is obviously much harder though.

## Generating a "turns-per-year" script through R's text generation capabilities




























